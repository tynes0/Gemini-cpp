\doxysection{function\+\_\+registry.\+h}
\hypertarget{function__registry_8h_source}{}\label{function__registry_8h_source}\index{gemini/function\_registry.h@{gemini/function\_registry.h}}
\mbox{\hyperlink{function__registry_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#ifndef\ GEMINI\_FUNCTION\_REGISTRY\_H}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#define\ GEMINI\_FUNCTION\_REGISTRY\_H}}
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <string>}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <functional>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <map>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <tuple>}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <nlohmann/json.hpp>}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{function__utils_8h}{internal/function\_utils.h}}"{}}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{logger_8h}{logger.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{generating__content__api__types_8h}{types/generating\_content\_api\_types.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespace_gemini_c_p_p}{GeminiCPP}}}
\DoxyCodeLine{00018\ \{}
\DoxyCodeLine{00024\ \ \ \ \ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_gemini_c_p_p_1_1_function_registry}{FunctionRegistry}}}
\DoxyCodeLine{00025\ \ \ \ \ \{}
\DoxyCodeLine{00026\ \ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1_registered_function}{RegisteredFunction}}}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_declaration}{FunctionDeclaration}}\ \mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1_registered_function_a9003626a98997382d5d96afd38311a76}{declaration}};}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \ \ \ \ std::function<nlohmann::json(\textcolor{keyword}{const}\ nlohmann::json\&)>\ \mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1_registered_function_ac55e53b2078c51ea8665c68b6463ccd7}{invoker}};\ }
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ====================================================================}}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ====\ Template\ metaprogramming\ traits\ for\ function\ introspection\ ====}}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ====================================================================}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits}{function\_traits}};}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Lambda\ /\ Functor}}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ ClassType,\ \textcolor{keyword}{typename}\ ReturnT,\ \textcolor{keyword}{typename}...\ Args>}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits}{function\_traits}}<ReturnT(ClassType::*)(Args...)\ const>}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits_3_01_return_t_07_class_type_1_1_5_82e8fe9f9ca6ffff5c25e347e40104b9_ae95b2a097287446403047818f740e148}{ArgsTuple}}\ =\ std::tuple<Args...>;}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits_3_01_return_t_07_class_type_1_1_5_82e8fe9f9ca6ffff5c25e347e40104b9_a8087b2c3035fcc0b50fa2992e973d019}{ReturnType}}\ =\ ReturnT;}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ ReturnT,\ \textcolor{keyword}{typename}...\ Args>}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits}{function\_traits}}<ReturnT(*)(Args...)>\ \{}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits_3_01_return_t_07_5_08_07_args_8_8_8_08_4_afd2ec6b9cb524439571f72afa4308520}{ArgsTuple}}\ =\ std::tuple<Args...>;}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits_3_01_return_t_07_5_08_07_args_8_8_8_08_4_ae000f4c181cf1dbb1230243626fda50f}{ReturnType}}\ =\ ReturnT;}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Functor\ Wrapper}}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits}{function\_traits}}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits}{function\_traits}}<decltype(\&T::operator())>\ \{\};}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ====================================================================}}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ====================================================================}}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ====================================================================}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Func>}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_gemini_c_p_p_1_1_function_registry_aa5f4b4ca78e3e7ba883b039a7f571883}{registerFunction}}(\textcolor{keyword}{const}\ std::string\&\ name,\ Func\&\&\ func,\ \textcolor{keyword}{const}\ std::string\&\ description,\ \textcolor{keyword}{const}\ std::vector<std::string>\&\ argNames)}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{using\ }Traits\ =\ \mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_registry_1_1function__traits}{function\_traits<std::decay\_t<Func>}}>;}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_declaration}{FunctionDeclaration}}\ decl;}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ decl.\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_declaration_a699471bf8c908833654f3465be97b6db}{name}}\ =\ name;}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \ \ decl.\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_declaration_a7aab6e026ac486440487222ef990b06c}{description}}\ =\ description;}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ decl.\mbox{\hyperlink{struct_gemini_c_p_p_1_1_function_declaration_ac37057aac42eaaf758504b2baa358c14}{parameters}}\ =\ generateSchema<typename\ Traits::ArgsTuple>(argNames);}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ invoker\ =\ [func\ =\ std::forward<Func>(func),\ argNames](\textcolor{keyword}{const}\ nlohmann::json\&\ args)\ -\/>\ nlohmann::json}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tupleArgs\ =\ \mbox{\hyperlink{namespace_gemini_c_p_p_1_1_internal_a943063159a5c8a1ba7b272dd3aa0563e}{Internal::jsonToTuple<typename\ Traits::ArgsTuple>}}(args,\ argNames);}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (std::is\_void\_v<typename\ Traits::ReturnType>)}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::apply(func,\ tupleArgs);}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\{\textcolor{stringliteral}{"{}result"{}},\ \textcolor{stringliteral}{"{}ok"{}}\}\};}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ std::apply(func,\ tupleArgs);}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{catch}\ (\textcolor{keyword}{const}\ std::exception\&\ e)}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8h_a857d902dd053d59ff9f012bb0ee1362b}{GEMINI\_ERROR}}(\textcolor{stringliteral}{"{}Function\ execution\ failed:\ \{\}"{}},\ e.what());}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\{\textcolor{stringliteral}{"{}error"{}},\ e.what()\}\};}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ functions\_[name]\ =\ \{decl,\ invoker\};}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8h_affa0edd6de77a8fbdb7e5c56ad52a243}{GEMINI\_INFO}}(\textcolor{stringliteral}{"{}Function\ registered:\ \{\}"{}},\ name);}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ [[nodiscard]]\ std::optional<nlohmann::json>\ \mbox{\hyperlink{class_gemini_c_p_p_1_1_function_registry_ac9667036492de30e19bafaa5e8d14069}{invoke}}(\textcolor{keyword}{const}\ std::string\&\ name,\ \textcolor{keyword}{const}\ nlohmann::json\&\ args)}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (functions\_.contains(name))}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ functions\_[name].invoker(args);}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ std::nullopt;}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ [[nodiscard]]\ \mbox{\hyperlink{struct_gemini_c_p_p_1_1_tool}{Tool}}\ \mbox{\hyperlink{class_gemini_c_p_p_1_1_function_registry_a76faf8b23319fb03796881fb4136cec2}{getTool}}()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00129\ \textcolor{keyword}{\ \ \ \ \ \ \ \ }\{}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_gemini_c_p_p_1_1_tool}{Tool}}\ t;}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ reg\ :\ std::views::values(functions\_))}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ t.\mbox{\hyperlink{struct_gemini_c_p_p_1_1_tool_a3eeb92f51bf5d33c7345eb68c0a685f3}{functionDeclarations}}.push\_back(reg.declaration);}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ t;}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ [[nodiscard]]\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{class_gemini_c_p_p_1_1_function_registry_a8966cf266d2de950d97e4a49b6566c25}{empty}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ functions\_.empty();\ \}}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ std::map<std::string,\ RegisteredFunction>\ functions\_;}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ TupleType,\ std::size\_t...\ Is>}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ nlohmann::json\ generateSchemaImpl(\textcolor{keyword}{const}\ std::vector<std::string>\&\ argNames,\ std::index\_sequence<Is...>)}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ nlohmann::json\ properties\ =\ nlohmann::json::object();}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \ \ nlohmann::json\ required\ =\ nlohmann::json::array();}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ (...,\ (}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ properties[argNames[Is]]\ =\ \mbox{\hyperlink{struct_gemini_c_p_p_1_1_internal_1_1_json_type_traits}{Internal::JsonTypeTraits<std::tuple\_element\_t<Is,\ TupleType>}}>::schema(),}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ required.push\_back(argNames[Is])}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ ));}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{\textcolor{stringliteral}{"{}type"{}},\ \textcolor{stringliteral}{"{}object"{}}\},}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{\textcolor{stringliteral}{"{}properties"{}},\ properties\},}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{\textcolor{stringliteral}{"{}required"{}},\ required\}}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ TupleType>}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ nlohmann::json\ generateSchema(\textcolor{keyword}{const}\ std::vector<std::string>\&\ argNames)}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ generateSchemaImpl<TupleType>(argNames,\ std::make\_index\_sequence<std::tuple\_size\_v<TupleType>>\{\});}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00169\ \ \ \ \ \};}
\DoxyCodeLine{00170\ \}}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ GEMINI\_FUNCTION\_REGISTRY\_H}}

\end{DoxyCode}
